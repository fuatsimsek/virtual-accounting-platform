{% extends "base.html" %}
{% block title %}Lead YÃ¶netimi{% endblock %}
{% block content %}
<section class="section-padding">
  <div class="container-custom">
    <!-- Header -->
    <div class="mb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          <i class="fas fa-users text-primary mr-3"></i>
          Lead YÃ¶netimi
        </h1>
        <p class="text-gray-600">MÃ¼ÅŸteri adaylarÄ±nÄ± yÃ¶netin, filtreleyin ve Ã¶deme/toplantÄ± sÃ¼reÃ§lerini takip edin.</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-2 rounded-lg">
          <div class="text-sm font-medium">Toplam Lead</div>
          <div class="text-2xl font-bold">{{ leads.total }}</div>
        </div>
        <div class="flex gap-2">
          <a class="btn-modern bg-green-500 hover:bg-green-600" href="{{ url_for('admin.export_leads', status=status, q=q) }}">
            <i class="fas fa-download mr-2"></i>CSV Ä°ndir
          </a>
          <form method="post" action="{{ url_for('admin.send_monthly_reminders') }}" style="display:inline-block;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-modern bg-orange-500 hover:bg-orange-600" onclick="return confirm('TÃ¼m aylÄ±k mÃ¼ÅŸterilere Ã¶deme hatÄ±rlatmasÄ± gÃ¶nderilsin mi?')">
              <i class="fas fa-bell mr-2"></i>HatÄ±rlatma GÃ¶nder
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Enhanced Filters -->
    <div class="card mb-6 bg-gradient-to-r from-gray-50 to-blue-50 border-2 border-blue-100">
      <div class="p-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-filter text-blue-600 mr-2"></i>
          Filtreler ve Arama
        </h3>
        <form class="grid grid-cols-1 md:grid-cols-5 gap-4" method="get">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Arama</label>
            <input name="q" value="{{ q or '' }}" placeholder="Ä°sim veya e-posta ara..." 
                   class="form-input w-full bg-white border-2 border-gray-200 focus:border-blue-500 rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Durum</label>
            <select name="status" class="form-input w-full bg-white border-2 border-gray-200 focus:border-blue-500 rounded-lg">
              <option value="">TÃ¼m Durumlar</option>
              <option value="pending" {% if status=='pending' %}selected{% endif %}>ğŸ”„ Bekleniyor</option>
              <option value="payment_pending" {% if status=='payment_pending' %}selected{% endif %}>ğŸ’° Ã–deme Bekleniyor</option>
              <option value="paid" {% if status=='paid' %}selected{% endif %}>âœ… Ã–dendi</option>
              <option value="completed" {% if status=='completed' %}selected{% endif %}>ğŸ¯ TamamlandÄ±</option>
              <option value="cancelled" {% if status=='cancelled' %}selected{% endif %}>âŒ Ä°ptal</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">MÃ¼ÅŸteri Tipi</label>
            <select name="lead_type" class="form-input w-full bg-white border-2 border-gray-200 focus:border-blue-500 rounded-lg">
              <option value="">TÃ¼m Tipler</option>
              <option value="pending" {% if lead_type=='pending' %}selected{% endif %}>â³ Bekleniyor</option>
              <option value="one_time" {% if lead_type=='one_time' %}selected{% endif %}>ğŸ¯ Tek Hizmet</option>
              <option value="monthly" {% if lead_type=='monthly' %}selected{% endif %}>ğŸ“… AylÄ±k MÃ¼ÅŸteri</option>
            </select>
          </div>
          <div class="flex gap-2 items-end">
            <a class="btn-modern bg-gray-500 hover:bg-gray-600 flex-1" href="{{ url_for('admin.leads') }}">
              <i class="fas fa-refresh mr-2"></i>SÄ±fÄ±rla
            </a>
            <button class="btn-modern bg-blue-500 hover:bg-blue-600 flex-1" type="submit">
              <i class="fas fa-search mr-2"></i>Filtrele
            </button>
          </div>
        </form>
      </div>
    </div>

    {% macro leads_table(leads_items) %}
    <div class="card overflow-x-auto mb-8 border-2 border-gray-100">
      <table class="min-w-full text-sm">
        <thead class="sticky top-0 bg-gradient-to-r from-gray-50 to-blue-50">
          <tr class="text-left text-gray-700 border-b-2 border-gray-200">
            <th class="py-4 px-4 font-semibold">ğŸ‘¤ MÃ¼ÅŸteri</th>
            <th class="py-4 px-4 font-semibold">ğŸ“§ Ä°letiÅŸim</th>
            <th class="py-4 px-4 font-semibold">ğŸ› ï¸ Hizmet</th>
            <th class="py-4 px-4 font-semibold">ğŸ·ï¸ Tip</th>
            <th class="py-4 px-4 font-semibold">ğŸ“Š Durum</th>
            <th class="py-4 px-4 font-semibold">ğŸ“… Tarih</th>
            <th class="py-4 px-4 font-semibold">ğŸ’° Ã–deme Bilgileri</th>
            <th class="py-4 px-4 font-semibold">âš™ï¸ Ä°ÅŸlemler</th>
          </tr>
        </thead>
        <tbody>
          {% for l in leads_items %}
          {% set appt = l.service_request.appointment if l.service_request else None %}
          {% set appt_cancelled = (appt and appt.status == 'cancelled') %}
          <tr class="border-b hover:bg-blue-50 transition-colors duration-200">
            <td class="py-4 px-4">
              <div class="font-semibold text-gray-900">{{ l.user.name if l.user else 'N/A' }}</div>
              <div class="text-xs text-gray-500">ID: {{ l.id }}</div>
            </td>
            <td class="py-4 px-4">
              <div class="text-gray-900">{{ l.user.email if l.user else 'N/A' }}</div>
              {% if l.user and l.user.phone %}
              <div class="text-xs text-gray-500">{{ l.user.phone }}</div>
              {% endif %}
            </td>
            <td class="py-4 px-4">
              <div class="font-medium text-gray-900">{{ l.service.name if l.service else 'N/A' }}</div>
              {% if appt and appt.platform %}
              <div class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full inline-block mt-1">
                {{ appt.platform|upper }}
              </div>
              {% endif %}
            </td>
            <td class="py-4 px-4">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium 
                {% if l.lead_type == 'one_time' %}bg-blue-100 text-blue-800 border border-blue-200
                {% elif l.lead_type == 'monthly' %}bg-green-100 text-green-800 border border-green-200
                {% elif l.lead_type in ['one_time_meeting_pending', 'monthly_meeting_pending'] %}bg-orange-100 text-orange-800 border border-orange-200
                {% elif l.lead_type in ['one_time_payment_pending', 'monthly_payment_pending'] %}bg-yellow-100 text-yellow-800 border border-yellow-200
                {% else %}bg-gray-100 text-gray-800 border border-gray-200{% endif %}">
                {% if l.lead_type == 'one_time' %}ğŸ¯ Tek Hizmet
                {% elif l.lead_type == 'monthly' %}ğŸ“… AylÄ±k MÃ¼ÅŸteri
                {% elif l.lead_type == 'one_time_meeting_pending' %}ğŸŸ  Tek Hizmet GÃ¶rÃ¼ÅŸme Bekleniyor
                {% elif l.lead_type == 'monthly_meeting_pending' %}ğŸŸ  AylÄ±k GÃ¶rÃ¼ÅŸme Bekleniyor
                {% elif l.lead_type == 'one_time_payment_pending' %}ğŸ’° Tek Hizmet Ã–deme Bekleniyor
                {% elif l.lead_type == 'monthly_payment_pending' %}ğŸ’° AylÄ±k Ã–deme Bekleniyor
                {% else %}â³ Bekleniyor{% endif %}
              </span>
            </td>
            <td class="py-4 px-4">
              {% if appt_cancelled %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                âŒ Ä°ptal
              </span>
              {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium 
                {% if l.status == 'payment_pending' %}bg-yellow-100 text-yellow-800 border border-yellow-200
                {% elif l.status == 'paid' %}bg-green-100 text-green-800 border border-green-200
                {% elif l.status == 'completed' %}bg-blue-100 text-blue-800 border border-blue-200
                {% elif l.status == 'cancelled' %}bg-red-100 text-red-800 border border-red-200
                {% else %}bg-gray-100 text-gray-800 border border-gray-200{% endif %}">
                {% if l.status == 'payment_pending' %}ğŸ’° Ã–deme Bekleniyor
                {% elif l.status == 'paid' %}âœ… Ã–dendi
                {% elif l.status == 'completed' %}ğŸ¯ TamamlandÄ±
                {% elif l.status == 'cancelled' %}âŒ Ä°ptal
                {% else %}ğŸ”„ Bekleniyor{% endif %}
              </span>
              {% endif %}
            </td>
            <td class="py-4 px-4">
              <div class="text-gray-900">{{ l.created_at.strftime('%d.%m.%Y') }}</div>
              <div class="text-xs text-gray-500">{{ l.created_at.strftime('%H:%M') }}</div>
            </td>
            <td class="py-4 px-4">
              {% if l.lead_type == 'monthly' and l.status == 'completed' %}
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                  {% if l.monthly_amount %}
                  <div class="text-sm font-semibold text-green-800 mb-1">
                    {{ "%.2f"|format(l.monthly_amount) }} â‚º/ay
                  </div>
                  {% endif %}
                  {% if l.iban %}
                  <div class="text-xs text-gray-600 mb-1">
                    <strong>IBAN:</strong> <code class="text-xs">{{ l.iban }}</code>
                  </div>
                  {% endif %}
                  {% if l.recipient_full_name %}
                  <div class="text-xs text-gray-600 mb-1">
                    <strong>AlÄ±cÄ±:</strong> {{ l.recipient_full_name }}
                  </div>
                  {% endif %}
                  {% if l.next_payment_date %}
                  <div class="text-xs text-gray-600 mb-2">
                    <strong>Sonraki Ã–deme:</strong> {{ l.next_payment_date.strftime('%d.%m.%Y') }}
                  </div>
                  {% endif %}

                  <!-- Ã–deme Bilgileri DÃ¼zenle -->
                  <form method="post" action="{{ url_for('admin.update_monthly_payment', lead_id=l.id) }}" class="mt-2 space-y-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                      <input name="new_amount" type="number" step="0.01" placeholder="Yeni Tutar (â‚º)" class="form-input text-xs bg-white border-2 border-gray-200 focus:border-green-500 rounded-lg" />
                      <input name="new_iban" placeholder="Yeni IBAN" class="form-input text-xs bg-white border-2 border-gray-200 focus:border-green-500 rounded-lg" />
                      <input name="new_recipient_full_name" placeholder="Yeni AlÄ±cÄ± Ad Soyad" class="form-input text-xs bg-white border-2 border-gray-200 focus:border-green-500 rounded-lg" />
                    </div>
                    <button type="submit" class="btn-modern bg-green-500 hover:bg-green-600 text-xs px-3 py-1"><i class="fas fa-save mr-1"></i>GÃ¼ncelle</button>
                  </form>
                  
                  <!-- Bekleyen Ã–demeler -->
                  {% set pending_payments = l.monthly_payments|selectattr('status', 'equalto', 'pending')|list %}
                  {% if pending_payments %}
                  <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded">
                    <div class="text-xs text-yellow-800 mb-1">
                      <i class="fas fa-clock"></i> <strong>KullanÄ±cÄ± Ã¶dediÄŸini sÃ¶ylÃ¼yor</strong>
                    </div>
                                         {% for payment in pending_payments %}
                     <div class="text-xs text-gray-600 mb-1">
                       {% set turkish_months = {
                         1: 'Ocak', 2: 'Åubat', 3: 'Mart', 4: 'Nisan', 5: 'MayÄ±s', 6: 'Haziran',
                         7: 'Temmuz', 8: 'AÄŸustos', 9: 'EylÃ¼l', 10: 'Ekim', 11: 'KasÄ±m', 12: 'AralÄ±k'
                       } %}
                       {{ turkish_months[payment.payment_month.month] }} {{ payment.payment_month.year }} - {{ "%.2f"|format(payment.amount) }} â‚º
                     </div>
                    <form method="post" action="{{ url_for('admin.confirm_monthly_payment', payment_id=payment.id) }}" style="display:inline;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-success btn-xs" onclick="return confirm('Bu Ã¶demeyi onaylamak istediÄŸinizden emin misiniz?')">
                        <i class="fas fa-check"></i> Ã–dedi
                      </button>
                    </form>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              {% else %}
                <div class="text-xs text-gray-400">-</div>
              {% endif %}
            </td>
            <td class="py-4 px-4">
              <div class="space-y-3">
                <!-- MÃ¼ÅŸteri Tipi GÃ¼ncelleme -->
                <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
                  <div class="text-xs text-gray-600 mb-2 font-semibold flex items-center gap-2">
                    <i class="fas fa-user-tag text-blue-600"></i> MÃ¼ÅŸteri Tipi GÃ¼ncelle
                  </div>
                  <form class="flex gap-2 flex-wrap" method="post" action="{{ url_for('admin.update_lead_type', lead_id=l.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <select name="lead_type" class="form-input text-xs bg-white border-2 border-gray-200 focus:border-blue-500 rounded-lg" style="max-width:240px" required>
                      <option value="one_time_meeting_pending" {% if l.lead_type == 'one_time_meeting_pending' or not l.lead_type %}selected{% endif %}>ğŸŸ  Tek Hizmet GÃ¶rÃ¼ÅŸme Bekleniyor</option>
                      <option value="monthly_meeting_pending" {% if l.lead_type == 'monthly_meeting_pending' %}selected{% endif %}>ğŸŸ  AylÄ±k GÃ¶rÃ¼ÅŸme Bekleniyor</option>
                      <option value="one_time_payment_pending" {% if l.lead_type == 'one_time_payment_pending' %}selected{% endif %}>ğŸ’° Tek Hizmet Ã–deme Bekleniyor</option>
                      <option value="monthly_payment_pending" {% if l.lead_type == 'monthly_payment_pending' %}selected{% endif %}>ğŸ’° AylÄ±k MÃ¼ÅŸteri Ã–deme Bekleniyor</option>
                      <option value="one_time" {% if l.lead_type == 'one_time' %}selected{% endif %}>ğŸ¯ Tek Hizmet</option>
                      <option value="monthly" {% if l.lead_type == 'monthly' %}selected{% endif %}>ğŸ“… AylÄ±k MÃ¼ÅŸteri</option>
                    </select>
                    <button class="btn-modern bg-blue-500 hover:bg-blue-600 text-xs px-3 py-1" type="submit">
                      <i class="fas fa-save mr-1"></i>GÃ¼ncelle
                    </button>
                  </form>
                </div>

                <!-- Ã–deme Talebi -->
                {% if l.lead_type in ['one_time_meeting_pending', 'monthly_meeting_pending'] and l.status == 'pending' %}
                <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
                  <div class="text-xs text-gray-600 mb-2 font-semibold flex items-center gap-2">
                    <i class="fas fa-handshake text-orange-600"></i> GÃ¶rÃ¼ÅŸme TamamlandÄ±
                  </div>
                  <form class="flex gap-2" method="post" action="{{ url_for('admin.update_lead_type', lead_id=l.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <select name="lead_type" class="form-input text-xs bg-white border-2 border-gray-200 focus:border-orange-500 rounded-lg" style="max-width:240px" required>
                      <option value="one_time_payment_pending" {% if l.lead_type == 'one_time_meeting_pending' %}selected{% endif %}>ğŸ’° Tek Hizmet Ã–deme Bekleniyor</option>
                      <option value="monthly_payment_pending" {% if l.lead_type == 'monthly_meeting_pending' %}selected{% endif %}>ğŸ’° AylÄ±k Ã–deme Bekleniyor</option>
                    </select>
                    <button class="btn-modern bg-orange-500 hover:bg-orange-600 text-xs px-3 py-1" type="submit">
                      <i class="fas fa-arrow-right mr-1"></i>GÃ¶rÃ¼ÅŸme SonrasÄ±
                    </button>
                  </form>
                </div>
                {% elif l.lead_type in ['one_time_payment_pending', 'monthly_payment_pending'] and l.status == 'pending' %}
                <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
                  <div class="text-xs text-gray-600 mb-2 font-semibold flex items-center gap-2">
                    <i class="fas fa-credit-card text-green-600"></i> Ã–deme Talebi GÃ¶nder
                  </div>
                  <form class="flex flex-wrap items-center gap-2" method="post" action="{{ url_for('admin.send_payment_request', lead_id=l.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input name="amount" type="number" step="0.01" placeholder="â‚º Tutar" 
                           class="form-input text-xs bg-white border-2 border-gray-200 focus:border-green-500 rounded-lg" style="max-width:160px" required />
                    <input name="iban" placeholder="IBAN" 
                           class="form-input text-xs bg-white border-2 border-gray-200 focus:border-green-500 rounded-lg" style="max-width:300px" required />
                    <input name="recipient_full_name" placeholder="AlÄ±cÄ± Ad Soyad" 
                           class="form-input text-xs bg-white border-2 border-gray-200 focus:border-green-500 rounded-lg" style="max-width:260px" 
                           accept-charset="utf-8" />
                    <button class="btn-modern bg-green-500 hover:bg-green-600 text-xs px-3 py-1" type="submit">
                      <i class="fas fa-paper-plane mr-1"></i>GÃ¶nder
                    </button>
                  </form>
                </div>
                {% endif %}

                <!-- Ã–deme OnayÄ± -->
                {% if l.status == 'payment_pending' %}
                <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
                  <div class="text-xs text-gray-600 mb-2 font-semibold flex items-center gap-2">
                    <i class="fas fa-badge-check text-green-600"></i> Ã–deme OnayÄ±
                  </div>
                  <div class="flex gap-2">
                    <form method="post" action="{{ url_for('admin.confirm_payment', lead_id=l.id) }}" style="display:inline-block;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn-modern bg-green-500 hover:bg-green-600 text-xs px-3 py-1" type="submit">
                        <i class="fas fa-check mr-1"></i>Ã–deme AlÄ±ndÄ±
                      </button>
                    </form>
                                         <button class="btn-modern bg-orange-500 hover:bg-orange-600 text-xs px-3 py-1" type="button" 
                             onclick="confirmCorrectPayment({{ l.id }}, '{{ l.user.name if l.user else 'MÃ¼ÅŸteri' }}')">
                       <i class="fas fa-edit mr-1"></i>DÃ¼zelt
                     </button>
                  </div>
                </div>
                {% endif %}

                <!-- KullanÄ±cÄ± Ã–deme Bildirimi OnayÄ± -->
                {% if l.status == 'user_paid' %}
                <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
                  <div class="text-xs text-gray-600 mb-2 font-semibold flex items-center gap-2">
                    <i class="fas fa-user-check text-blue-600"></i> KullanÄ±cÄ± Ã–deme Bildirimi
                  </div>
                  <div class="text-xs text-gray-600 mb-2">
                    <i class="fas fa-info-circle"></i> MÃ¼ÅŸteri Ã¶deme yaptÄ±ÄŸÄ±nÄ± bildirdi
                  </div>
                  <div class="flex gap-2">
                    <form method="post" action="{{ url_for('admin.confirm_user_payment', lead_id=l.id) }}" style="display:inline-block;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn-modern bg-green-500 hover:bg-green-600 text-xs px-3 py-1" type="submit">
                        <i class="fas fa-check mr-1"></i>Ã–deme AlÄ±ndÄ±
                      </button>
                    </form>
                  </div>
                </div>
                {% endif %}

                <!-- ToplantÄ± Planla -->
                {% if l.status == 'paid' %}
                <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
                  <div class="text-xs text-gray-600 mb-2 font-semibold flex items-center gap-2">
                    <i class="fas fa-calendar-plus text-blue-600"></i> ToplantÄ± Planla
                  </div>
                  <form class="flex flex-wrap items-center gap-2" method="post" action="{{ url_for('admin.schedule_meeting', lead_id=l.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input name="meeting_date" type="date" 
                           class="form-input text-xs bg-white border-2 border-gray-200 focus:border-blue-500 rounded-lg" style="max-width:180px" required />
                    <input name="meeting_time" type="time" 
                           class="form-input text-xs bg-white border-2 border-gray-200 focus:border-blue-500 rounded-lg" style="max-width:140px" required />
                    <select name="platform" 
                            class="form-input text-xs bg-white border-2 border-gray-200 focus:border-blue-500 rounded-lg" style="max-width:180px" required>
                      <option value="">Platform SeÃ§in</option>
                      <option value="meet" {% if appt and appt.platform == 'meet' %}selected{% endif %}>ğŸ“¹ Google Meet</option>
                      <option value="zoom" {% if appt and appt.platform == 'zoom' %}selected{% endif %}>ğŸ“¹ Zoom</option>
                      <option value="teams" {% if appt and appt.platform == 'teams' %}selected{% endif %}>ğŸ“¹ Teams</option>
                    </select>
                    <input name="meeting_link" placeholder="ToplantÄ± Linki" 
                           class="form-input text-xs bg-white border-2 border-gray-200 focus:border-blue-500 rounded-lg" style="max-width:320px" required />
                    <button class="btn-modern bg-blue-500 hover:bg-blue-600 text-xs px-3 py-1" type="submit">
                      <i class="fas fa-calendar-check mr-1"></i>Planla
                    </button>
                  </form>
                </div>
                {% endif %}



                <!-- Durum YÃ¶netimi -->
                <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
                  <div class="text-xs text-gray-600 mb-2 font-semibold flex items-center gap-2">
                    <i class="fas fa-flag text-red-600"></i> Durum YÃ¶netimi
                  </div>
                  {% if l.status != 'cancelled' %}
                  <form method="post" action="{{ url_for('admin.cancel_lead', lead_id=l.id) }}" style="display:inline-block;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn-modern bg-red-500 hover:bg-red-600 text-xs px-3 py-1" 
                            onclick="return confirm('Bu lead iptal edilsin mi?')">
                      <i class="fas fa-times mr-1"></i>Ä°ptal Et
                    </button>
                  </form>
                  {% else %}
                  <form method="post" action="{{ url_for('admin.restore_lead', lead_id=l.id) }}" style="display:inline-block;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn-modern bg-blue-500 hover:bg-blue-600 text-xs px-3 py-1" 
                            onclick="return confirm('Bu lead geri alÄ±nsÄ±n mÄ±?')">
                      <i class="fas fa-undo mr-1"></i>Geri Al
                    </button>
                  </form>
                  {% endif %}
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endmacro %}

    {% set items = leads.items or [] %}
         {% set groups = [
       ('âŒ Ä°ptal Edilenler', 'red', items|selectattr('service_request.appointment.status','equalto','cancelled')|list + items|selectattr('status','equalto','cancelled')|list),
       ('ğŸ’° Ã–deme Bekleyenler', 'yellow', items|selectattr('status','equalto','payment_pending')|list),
       ('ğŸ‘¤ KullanÄ±cÄ± Ã–deme Bildirimi', 'orange', items|selectattr('status','equalto','user_paid')|list),
       ('ğŸ“… GÃ¶rÃ¼ÅŸme Bekleyenler', 'blue', items|selectattr('status','equalto','meeting_pending')|list),
       ('ğŸ”„ Bekleyenler', 'gray', items|selectattr('status','equalto','pending')|list),
       ('âœ… Ã–denenler', 'green', items|selectattr('status','equalto','paid')|list),
       ('ğŸ¯ Tamamlananlar', 'blue', items|selectattr('status','equalto','completed')|list),
       ('ğŸ‘¥ Aktif MÃ¼ÅŸterilerim', 'purple', items|selectattr('status','equalto','completed')|selectattr('lead_type','equalto','monthly')|list)
     ] %}

    {% for title, color, group_items in groups %}
      {% if group_items and group_items|length > 0 %}
      <div class="mb-4 flex items-center gap-3">
                 <div class="w-2 h-8 rounded-full" style="background: linear-gradient(135deg, 
           {% if color=='red' %}#ef4444, #dc2626
           {% elif color=='yellow' %}#f59e0b, #d97706
           {% elif color=='orange' %}#f97316, #ea580c
           {% elif color=='green' %}#10b981, #059669
           {% elif color=='blue' %}#3b82f6, #2563eb
           {% elif color=='purple' %}#8b5cf6, #7c3aed
           {% else %}#6b7280, #4b5563{% endif %});"></div>
        <h2 class="text-lg font-bold text-gray-800">{{ title }} ({{ group_items|length }})</h2>
      </div>
      {{ leads_table(group_items) }}
      {% endif %}
    {% endfor %}

    {% if not leads.items %}
      <div class="card p-12 text-center">
        <div class="text-gray-400 text-6xl mb-4">
          <i class="fas fa-search"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">KayÄ±t BulunamadÄ±</h3>
        <p class="text-gray-500">Arama kriterlerinize uygun lead bulunamadÄ±.</p>
      </div>
    {% endif %}

  </div>

  <style>
    .btn-modern {
      @apply inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
    }
    
    .form-input {
      @apply px-3 py-2 text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50;
    }
    
    .card {
      @apply bg-white rounded-xl shadow-lg border border-gray-100;
    }
    
    .section-padding {
      @apply py-8 px-4;
    }
    
    .container-custom {
      @apply max-w-7xl mx-auto;
    }
    
         .bg-orange-100 { background-color: #ffedd5 !important; }
     .text-orange-800 { color: #9a3412 !important; }
     .border-orange-200 { border-color: #fed7aa !important; }
   </style>

       <script>
      function confirmCorrectPayment(leadId, customerName) {
        if (confirm(`${customerName} iÃ§in Ã¶deme bilgilerini dÃ¼zeltmek istediÄŸinizden emin misiniz?\n\nBu iÅŸlem Ã¶deme bilgilerini sÄ±fÄ±rlayacak, lead'i "Bekleniyor" durumuna Ã§evirecek ve yeni Ã¶deme bilgileri girebileceksiniz.`)) {
          // Form oluÅŸtur ve gÃ¶nder
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/admin/lead/${leadId}/correct-payment`;
          
          // CSRF token ekle
          const csrfToken = document.querySelector('input[name="csrf_token"]').value;
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrf_token';
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);
          
          document.body.appendChild(form);
          form.submit();
        }
      }
    </script>
 </section>
{% endblock %}
