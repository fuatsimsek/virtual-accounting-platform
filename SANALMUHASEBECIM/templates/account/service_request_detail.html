{% extends 'base.html' %}

{% block title %}Hizmet Talebi Detayı{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-clipboard-list"></i> Hizmet Talebi Detayı
                    </h4>
                </div>
                <div class="card-body">
                    {% if service_request %}
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="text-primary">{{ service_request.service.name }}</h5>
                                <p class="text-muted">{{ service_request.service.description }}</p>
                                
                                {% if service_request.additional_details %}
                                    <div class="mt-3">
                                        <h6><i class="fas fa-edit"></i> Ekstra Detaylar:</h6>
                                        <div class="alert alert-info">
                                            {{ service_request.additional_details }}
                                        </div>
                                    </div>
                                {% endif %}
                                
                                <div class="mt-4">
                                    <h6><i class="fas fa-info-circle"></i> Talep Bilgileri:</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Talep Tarihi:</strong> {{ service_request.created_at.strftime('%d.%m.%Y %H:%M') }}</li>
                                        <li><strong>Durum:</strong> 
                                            {% if service_request.status == 'pending' %}
                                                <span class="badge bg-warning">Beklemede</span>
                                            {% elif service_request.status == 'approved' %}
                                                <span class="badge bg-info">Onaylandı</span>
                                            {% elif service_request.status == 'payment_confirmed' %}
                                                <span class="badge bg-primary">Ödeme Alındı</span>
                                            {% elif service_request.status == 'completed' %}
                                                <span class="badge bg-success">Tamamlandı</span>
                                            {% elif service_request.status == 'rejected' %}
                                                <span class="badge bg-danger">Reddedildi</span>
                                            {% endif %}
                                        </li>
                                    </ul>
                                </div>

                                <!-- İlgili Randevu Bilgileri -->
                                {% if appointment %}
                                <div class="mt-4">
                                    <h6><i class="fas fa-calendar-alt"></i> Randevu Bilgileri:</h6>
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p><strong>Tarih:</strong> {{ appointment.appointment_datetime.strftime('%d.%m.%Y') }}</p>
                                                    <p><strong>Saat:</strong> {{ appointment.appointment_datetime.strftime('%H:%M') }}</p>
                                                    <p><strong>Platform:</strong> {{ appointment.platform or 'Belirtilmemiş' }}</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <p><strong>Durum:</strong> 
                                                        {% if appointment.status == 'pending' %}
                                                            <span class="badge bg-warning">E-posta Onayı Bekleniyor</span>
                                                        {% elif appointment.status == 'email_confirmed' %}
                                                            <span class="badge bg-info">Yetkili Onayı Bekleniyor</span>
                                                        {% elif appointment.status == 'confirmed' %}
                                                            <span class="badge bg-success">Onaylandı</span>
                                                        {% elif appointment.status == 'cancelled' %}
                                                            <span class="badge bg-danger">İptal Edildi</span>
                                                        {% endif %}
                                                    </p>
                                                    {% if appointment.meeting_link %}
                                                    <p><strong>Toplantı Linki:</strong> 
                                                        <a href="{{ appointment.meeting_link }}" target="_blank" class="btn btn-sm btn-primary">
                                                            <i class="fas fa-video"></i> Toplantıya Katıl
                                                        </a>
                                                    </p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- İlgili Lead Bilgileri -->
                                {% if lead %}
                                {% set appt_cancelled = (appointment and appointment.status == 'cancelled') %}
                                <div class="mt-4">
                                    <h6><i class="fas fa-users"></i> Müşteri Durumu:</h6>
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p><strong>Müşteri Tipi:</strong> 
                                                        {% if lead.lead_type == 'one_time' %}
                                                            <span class="badge bg-blue-100 text-blue-800">Tek Hizmet</span>
                                                        {% elif lead.lead_type == 'monthly' %}
                                                            <span class="badge bg-green-100 text-green-800">Aylık Müşteri</span>
                                                        {% elif lead.lead_type == 'one_time_meeting_pending' %}
                                                            <span class="badge bg-orange-100 text-orange-800">Tek Hizmet Görüşme Bekleniyor</span>
                                                        {% elif lead.lead_type == 'monthly_meeting_pending' %}
                                                            <span class="badge bg-orange-100 text-orange-800">Aylık Görüşme Bekleniyor</span>
                                                        {% elif lead.lead_type == 'one_time_payment_pending' %}
                                                            <span class="badge bg-yellow-100 text-yellow-800">Tek Hizmet Ödeme Bekleniyor</span>
                                                        {% elif lead.lead_type == 'monthly_payment_pending' %}
                                                            <span class="badge bg-yellow-100 text-yellow-800">Aylık Ödeme Bekleniyor</span>
                                                        {% else %}
                                                            <span class="badge bg-gray-100 text-gray-800">Bekleniyor</span>
                                                        {% endif %}
                                                    </p>
                                                    <p><strong>Durum:</strong> 
                                                        {% if appt_cancelled %}
                                                            <span class="badge bg-danger">İptal Edildi</span>
                                                        {% else %}
                                                            {% if lead.status == 'pending' %}
                                                                <span class="badge bg-warning">Bekleniyor</span>
                                                            {% elif lead.status == 'payment_pending' %}
                                                                <span class="badge bg-yellow-100 text-yellow-800">Ödeme Bekleniyor</span>
                                                            {% elif lead.status == 'paid' %}
                                                                <span class="badge bg-green-100 text-green-800">Ödendi</span>
                                                            {% elif lead.status == 'completed' %}
                                                                <span class="badge bg-blue-100 text-blue-800">Tamamlandı</span>
                                                            {% elif lead.status == 'cancelled' %}
                                                                <span class="badge bg-red-100 text-red-800">İptal</span>
                                                            {% endif %}
                                                        {% endif %}
                                                    </p>
                                                </div>
                                                <div class="col-md-6">
                                                    <p><strong>Oluşturulma:</strong> {{ lead.created_at.strftime('%d.%m.%Y') }}</p>
                                                    
                                                    {% if lead.status == 'payment_pending' %}
                                                        {% if lead.one_time_amount %}
                                                        <p><strong>Ödeme Tutarı:</strong> {{ "%.2f"|format(lead.one_time_amount) }} ₺</p>
                                                        {% endif %}
                                                        {% if lead.monthly_amount %}
                                                        <p><strong>Aylık Tutar:</strong> {{ "%.2f"|format(lead.monthly_amount) }} ₺</p>
                                                        {% endif %}
                                                        {% if lead.iban %}
                                                        <p><strong>IBAN:</strong> <code>{{ lead.iban }}</code></p>
                                                        {% endif %}
                                                        {% if lead.recipient_full_name %}
                                                        <p><strong>Alıcı:</strong> {{ lead.recipient_full_name }}</p>
                                                        {% endif %}
                                                        {% if lead.next_payment_date %}
                                                        <p><strong>Sonraki Ödeme:</strong> 
                                                            <span class="{% if lead.next_payment_date <= now %}text-danger font-weight-bold{% endif %}">
                                                                {{ lead.next_payment_date.strftime('%d.%m.%Y') }}
                                                                {% if lead.next_payment_date <= now %}
                                                                    <span class="badge badge-danger ml-2">Gecikmiş</span>
                                                                {% endif %}
                                                            </span>
                                                        </p>
                                                        {% endif %}
                                                                                                         {% elif lead.lead_type in ['one_time_meeting_pending', 'monthly_meeting_pending'] %}
                                                         <p class="text-muted"><em>Görüşme planlanıyor...</em></p>
                                                     {% elif lead.status in ['pending', 'payment_pending'] %}
                                                         <p class="text-muted"><em>Ödeme bilgileri henüz gönderilmedi.</em></p>
                                                     {% endif %}
                                                </div>
                                            </div>
                                            
                                            <!-- Durum Mesajları -->
                                            {% if appt_cancelled %}
                                            <div class="alert alert-light mt-3">
                                                <i class="fas fa-info-circle"></i> <strong>Randevu İptal Edildi</strong><br>
                                                <small>Hizmet sürecine devam etmek için lütfen yeniden randevu planlayın.</small>
                                            </div>
                                            {% elif lead.lead_type in ['one_time_meeting_pending', 'monthly_meeting_pending'] %}
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-calendar-check"></i> <strong>Görüşme Bekleniyor</strong><br>
                                                <small>Görüşme planlanıyor. Görüşme sonrası ödeme bilgileri gönderilecektir.</small>
                                            </div>
                                            {% elif lead.status == 'payment_pending' %}
                                            <div class="alert alert-warning mt-3">
                                                <i class="fas fa-credit-card"></i> <strong>Ödeme Bekleniyor</strong><br>
                                                <small>Ödeme bilgileri gönderildi. Ödeme yaptıktan sonra toplantı planlanacaktır.</small>
                                            </div>
                                            {% elif lead.status == 'paid' %}
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-clock"></i> <strong>Ödeme Alındı</strong><br>
                                                <small>Ödemeniz alındı. Toplantı planlanıyor...</small>
                                            </div>
                                            {% elif lead.status == 'completed' %}
                                                {% set notification_id = "service_completed_" + lead.id|string %}
                                                {% if not current_user.has_seen_notification('service_completed', notification_id) %}
                                                <div class="alert alert-success mt-3" data-notification-id="{{ notification_id }}">
                                                    <i class="fas fa-check-circle"></i> <strong>Hizmet Tamamlandı</strong><br>
                                                    <small>Hizmetiniz başarıyla tamamlandı.</small>
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6><i class="fas fa-clock"></i> Genel Durum</h6>
                                        {% if service_request.status == 'pending' %}
                                            <div class="alert alert-warning">
                                                <i class="fas fa-hourglass-half"></i>
                                                <strong>Beklemede</strong><br>
                                                <small>Talebiniz yetkili tarafından inceleniyor.</small>
                                            </div>
                                        {% elif service_request.status == 'approved' %}
                                            <div class="alert alert-info">
                                                <i class="fas fa-check-circle"></i>
                                                <strong>Onaylandı</strong><br>
                                                <small>Talebiniz onaylandı. Görüşme planlanıyor.</small>
                                            </div>
                                        {% elif service_request.status == 'payment_confirmed' %}
                                            <div class="alert alert-primary">
                                                <i class="fas a-credit-card"></i>
                                                <strong>Ödeme Alındı</strong><br>
                                                <small>Ödemeniz alındı. Toplantı planlanacak.</small>
                                            </div>
                                        {% elif service_request.status == 'completed' %}
                                            {% set notification_id = "service_completed_" + lead.id|string if lead else "service_completed_" + service_request.id|string %}
                                            {% if not current_user.has_seen_notification('service_completed', notification_id) %}
                                            <div class="alert alert-success" data-notification-id="{{ notification_id }}">
                                                <i class="fas fa-check-double"></i>
                                                <strong>Tamamlandı</strong><br>
                                                <small>Hizmetiniz başarıyla tamamlandı.</small>
                                            </div>
                                            {% endif %}
                                        {% elif service_request.status == 'rejected' %}
                                            <div class="alert alert-danger">
                                                <i class="fas fa-times-circle"></i>
                                                <strong>Reddedildi</strong><br>
                                                <small>Talebiniz reddedildi.</small>
                                            </div>
                                        {% endif %}

                                        <!-- Hızlı Aksiyonlar -->
                                        <div class="mt-3">
                                            <h6><i class="fas fa-tools"></i> Hızlı Aksiyonlar</h6>
                                            <div class="d-grid gap-2">
                                                <a href="{{ url_for('account.my_services') }}" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-list"></i> Tüm Hizmetlerim
                                                </a>
                                                {% if appointment and appointment.status == 'pending' %}
                                                <a href="{{ url_for('booking.new_appointment', service_request_id=service_request.id) }}" class="btn btn-outline-warning btn-sm">
                                                    <i class="fas fa-calendar-plus"></i> Randevu Düzenle
                                                </a>
                                                {% endif %}
                                                {% if appointment and appointment.status == 'cancelled' %}
                                                <a href="{{ url_for('booking.new_appointment', service_request_id=service_request.id) }}" class="btn btn-outline-danger btn-sm">
                                                    <i class="fas fa-redo"></i> Yeniden Randevu Al
                                                </a>
                                                {% endif %}
                                                {% if lead and lead.status == 'payment_pending' %}
                                                <div class="alert alert-info">
                                                    <i class="fas fa-info-circle"></i>
                                                    <small>Ödeme bilgileri gönderildi. IBAN ve tutar bilgilerini kontrol edin.</small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Hizmet talebi bulunamadı.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.bg-blue-100 { background-color: #dbeafe !important; }
.text-blue-800 { color: #1e40af !important; }
.bg-green-100 { background-color: #dcfce7 !important; }
.text-green-800 { color: #166534 !important; }
.bg-yellow-100 { background-color: #fef3c7 !important; }
.text-yellow-800 { color: #92400e !important; }
.bg-orange-100 { background-color: #ffedd5 !important; }
.text-orange-800 { color: #9a3412 !important; }
.bg-gray-100 { background-color: #f3f4f6 !important; }
.text-gray-800 { color: #1f2937 !important; }
.bg-red-100 { background-color: #fee2e2 !important; }
.text-red-800 { color: #991b1b !important; }

.card {
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.alert {
    border-radius: 6px;
    border: none;
}
</style>

<script>
// Mark notifications as seen when they are displayed
document.addEventListener('DOMContentLoaded', function() {
    const notifications = document.querySelectorAll('.alert-success[data-notification-id]');
    notifications.forEach(function(notification) {
        const notificationId = notification.getAttribute('data-notification-id');
        const notificationType = 'service_completed';
        
        // Mark as seen via AJAX
        fetch('{{ url_for("account.mark_notification_seen") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                type: notificationType,
                id: notificationId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Notification marked as seen:', notificationId);
            }
        })
        .catch(error => {
            console.error('Error marking notification as seen:', error);
        });
    });
});
</script>
{% endblock %}
