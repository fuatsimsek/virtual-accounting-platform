{% extends "base.html" %}
{% block title %}RandevularÄ±m{% endblock %}
{% block content %}
<section class="section-padding">
  <!-- Hero -->
  <div class="mb-6">
    <div class="rounded-2xl p-6 md:p-8 text-white"
         style="background: linear-gradient(135deg, #4338ca 0%, #6366f1 55%, #8b5cf6 100%); box-shadow: 0 10px 30px rgba(0,0,0,0.15);">
      <div class="flex items-start justify-between gap-6 flex-col md:flex-row">
        <div class="flex-1">
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight mt-1">RandevularÄ±m</h1>
          <p class="opacity-90 mt-2 text-sm md:text-base">RandevularÄ±nÄ±zÄ± hÄ±zla gÃ¶rÃ¼n, yÃ¶netin ve yeni randevu oluÅŸturun. Randevu saatine <b>5 saat</b> kalana kadar iptal edebilirsiniz.</p>
        </div>
        <div class="flex items-center gap-3 w-full md:w-auto">
          <div class="hidden md:flex items-center gap-3">
            <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/15 border border-white/20 shadow-sm">
              <span class="inline-flex items-center justify-center w-7 h-7 rounded-lg text-white" style="background: rgba(255,255,255,.18);"><i class="fas fa-list"></i></span>
              <div>
                <div class="text-[10px] uppercase tracking-wider opacity-80">Toplam</div>
                <div class="text-sm font-semibold">{{ appointments|length }}</div>
              </div>
            </div>
            <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/15 border border-white/20 shadow-sm">
              <span class="inline-flex items-center justify-center w-7 h-7 rounded-lg text-white" style="background: rgba(255,255,255,.18);"><i class="fas fa-check-circle"></i></span>
              <div>
                <div class="text-[10px] uppercase tracking-wider opacity-80">OnaylÄ±</div>
                <div class="text-sm font-semibold">{{ (appointments|selectattr('status','equalto','confirmed')|list)|length }}</div>
              </div>
            </div>
          </div>
          <a href="{{ url_for('booking.new_appointment') }}" class="btn-pill blue w-full md:w-auto text-center">
            {% if appointments %}
              {% set last_appointment = appointments[0] %}
              {% if last_appointment.status in ['confirmed', 'pending', 'email_confirmed', 'awaiting_payment', 'paid', 'completed'] %}
                <i class="fas fa-calendar-alt"></i> Randevu Durumum
              {% else %}
                <i class="fas fa-plus"></i> Yeni Randevu
              {% endif %}
            {% else %}
              <i class="fas fa-plus"></i> Yeni Randevu
            {% endif %}
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="container-custom max-w-5xl">
    <div class="card">

      {% if appointments %}
      {% set status_labels = {
        'confirmed': 'OnaylandÄ±',
        'pending': 'Beklemede',
        'email_confirmed': 'E-posta OnaylandÄ±',
        'cancelled': 'Ä°ptal',
        'awaiting_payment': 'Ã–deme Bekleniyor',
        'paid': 'Ã–dendi',
        'completed': 'TamamlandÄ±'
      } %}

      <!-- Desktop/tablet gÃ¶rÃ¼nÃ¼m -->
      <div class="hidden md:block overflow-x-auto rounded-lg border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarih</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saat</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AmaÃ§</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ä°ÅŸlemler</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for a in appointments %}
            <tr class="hover:bg-gray-50 transition">
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <span class="text-lg">ğŸ“…</span>
                  <span>{{ a.appointment_datetime.strftime('%d.%m.%Y') }}</span>
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <span class="text-lg">â°</span>
                  <span>{{ a.appointment_datetime.strftime('%H:%M') }}</span>
                </div>
              </td>
              <td class="px-4 py-3" title="{{ a.purpose or '-' }}">
                <div class="truncate max-w-xs">{{ a.purpose or '-' }}</div>
              </td>
              <td class="px-4 py-3">
                {% set s = a.status %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium
                  {% if s == 'confirmed' %} bg-green-100 text-green-800
                  {% elif s == 'pending' %} bg-yellow-100 text-yellow-800
                  {% elif s == 'cancelled' %} bg-gray-200 text-gray-700
                  {% elif s == 'awaiting_payment' %} bg-orange-100 text-orange-800
                  {% elif s == 'paid' %} bg-blue-100 text-blue-800
                  {% elif s == 'completed' %} bg-primary-100 text-primary-800
                  {% else %} bg-gray-100 text-gray-800{% endif %}">
                  {{ status_labels.get(s, s) }}
                </span>
              </td>
              <td class="px-4 py-3 text-center whitespace-nowrap">
                <div class="flex flex-col gap-2 items-center">
                  {# GÃ¶rÃ¼ÅŸme BaÅŸlat butonu - sadece onaylanmÄ±ÅŸ randevular iÃ§in #}
                  {% if a.status == 'confirmed' %}
                  <a href="{{ url_for('booking.new_appointment') }}" class="btn-primary text-sm whitespace-nowrap">
                    <i class="fas fa-video"></i> GÃ¶rÃ¼ÅŸme BaÅŸlat
                  </a>
                  {% endif %}
                  
                  {# Ä°ptal butonu - sadece iptal edilebilir durumlar iÃ§in #}
                  {% if a.status not in ['cancelled','completed'] %}
                  {% set time_left_hours = ((a.appointment_datetime - now_utc).total_seconds() / 3600) %}
                  {% if time_left_hours > 5 %}
                  <button type="button" class="btn-soft text-sm open-cancel-modal" data-appointment-id="{{ a.id }}" data-appointment-dt="{{ a.appointment_datetime.strftime('%d.%m.%Y %H:%M') }}">
                    <i class="fas fa-ban"></i> Ä°ptal Et
                  </button>
                  {% else %}
                    <button type="button" class="btn-soft text-sm" disabled title="Randevu saatine 5 saatten az kaldÄ±ÄŸÄ± iÃ§in iptal edilemez">Ä°ptal Edilemez</button>
                  {% endif %}
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      
      {% else %}
        <div class="text-center text-gray-700 py-14">
          <div class="mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-3"
               style="background: linear-gradient(135deg, #e0e7ff 0%, #ede9fe 100%);">
            <span class="text-2xl">ğŸ“…</span>
          </div>
          <h2 class="text-lg font-semibold">HenÃ¼z randevunuz yok</h2>
          <p class="text-sm text-gray-500 mt-1">Hemen yeni bir randevu oluÅŸturarak baÅŸlayÄ±n.</p>
          <a href="{{ url_for('booking.new_appointment') }}" class="btn-primary inline-block mt-4">Randevu OluÅŸtur</a>
        </div>
      {% endif %}
    </div>
  </div>

  {# Ä°ptal ModalÄ± #}
  <div id="cancelModal" style="display:none; position: fixed; inset: 0; z-index: 1000;">
    <div class="modal-backdrop" style="position:absolute; inset:0; background: rgba(0,0,0,0.45); z-index: 1000;"></div>
    <div class="modal-panel" style="position:relative; z-index: 1001; max-width: 520px; margin: 8vh auto; background: #fff; border-radius: 14px; overflow:hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.25);">
      <div style="padding: 20px 22px; border-bottom: 1px solid #eef2f7; display:flex; align-items:center; gap:10px;">
        <div style="width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#fee2e2;color:#b91c1c;"><i class="fas fa-exclamation-triangle"></i></div>
        <div>
          <div style="font-weight: 700; font-size: 16px; color:#0f172a;">Randevuyu Ä°ptal Et</div>
          <div style="font-size: 12px; color:#64748b;">Randevu saatine 5 saat kalana kadar iptal edebilirsiniz.</div>
        </div>
      </div>
      <form id="cancelForm" method="post" action="#">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div style="padding: 18px 22px;">
          <div style="margin-bottom:10px; font-size:14px; color:#334155;">LÃ¼tfen iptal sebebinizi seÃ§in (opsiyonel):</div>
          <div style="display:grid; gap:8px;">
            <label style="display:flex; gap:10px; align-items:center; font-size:14px; color:#334155; cursor:pointer;">
              <input type="radio" name="cancel_reason" value="plan_change">
              PlanÄ±m deÄŸiÅŸti
            </label>
            <label style="display:flex; gap:10px; align-items:center; font-size:14px; color:#334155; cursor:pointer;">
              <input type="radio" name="cancel_reason" value="not_available">
              Belirtilen saatte uygun deÄŸilim
            </label>
            <label style="display:flex; gap:10px; align-items:center; font-size:14px; color:#334155; cursor:pointer;">
              <input type="radio" name="cancel_reason" value="other">
              DiÄŸer
            </label>
          </div>
          <div style="margin-top:12px;">
            <textarea name="cancel_note" rows="3" placeholder="Opsiyonel not ekleyebilirsiniz" style="width:100%; border:1px solid #e5e7eb; border-radius:8px; padding:10px; font-size:14px; resize:vertical;" tabindex="0"></textarea>
          </div>
          <div id="cancelApptInfo" style="margin-top:12px; font-size:12px; color:#64748b;"></div>
        </div>
        <div style="padding: 14px 22px; border-top: 1px solid #eef2f7; display:flex; justify-content:flex-end; gap:10px;">
          <button type="button" id="cancelCloseBtn" class="btn-soft" style="padding:10px 14px; border-radius:8px; background:#f1f5f9; color:#334155; border:1px solid #e2e8f0;">VazgeÃ§</button>
          <button type="submit" class="btn-primary" style="padding:10px 16px; border-radius:8px; background:#ef4444; color:#fff; border:1px solid #dc2626;"><i class="fas fa-ban"></i> Ä°ptal Et</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      var openButtons = document.querySelectorAll('.open-cancel-modal');
      var modal = document.getElementById('cancelModal');
      var closeBtn = document.getElementById('cancelCloseBtn');
      var form = document.getElementById('cancelForm');
      var infoEl = document.getElementById('cancelApptInfo');
      var actionTemplate = '{{ url_for('booking.cancel_appointment', appointment_id=0) }}';

      function setFormAction(appointmentId){
        var action = actionTemplate.replace('/0/', '/' + appointmentId + '/');
        form.setAttribute('action', action);
      }
      function openModalFor(id, dt){
        setFormAction(id);
        infoEl.textContent = dt ? ('SeÃ§ilen randevu: ' + dt) : '';
        modal.style.display = 'block';
        // Focus first interactive element
        var firstRadio = form.querySelector('input[type="radio"]');
        if(firstRadio){ firstRadio.focus(); }
      }
      function closeModal(){
        modal.style.display = 'none';
      }
      openButtons.forEach(function(btn){
        btn.addEventListener('click', function(){
          openModalFor(btn.getAttribute('data-appointment-id'), btn.getAttribute('data-appointment-dt'));
        });
      });
      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', function(e){
        if(e.target === modal){ closeModal(); }
      });
    })();
  </script>
</section>
{% endblock %}

